<!doctype html>
<html lang="en" dir="ltr">

<head>
  <meta charset="utf-8" />

  <title>Flask App</title>

  <!-- Bootstraps Java Scipts Links -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
    integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous" />
  <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
    integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
    integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
    crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
    integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
    crossorigin="anonymous"></script>

  <!-- JQuery links  -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

  <!--High CHART LIVE  -->
  <script src="http://code.highcharts.com/highcharts.js"></script>
  <script src="http://code.highcharts.com/highcharts-more.js"></script>
  <script src="http://code.highcharts.com/modules/exporting.js"></script>

  <!--Gauge  -->

  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/highcharts-more.js"></script>
  <script src="https://code.highcharts.com/modules/solid-gauge.js"></script>
  <script type="text/javascript" src="http://pubnub.github.io/eon/lib/eon.js"></script>
</head>

<body>
  <div class="jumbotron">
    <h1 class="text-center text-white">Monitoring Air Quality in Open Mining Areas</h1>
  </div>
  <br />
  <br />

  <div>
    <!-- Container for the gauge chart -->
    <div id="gauge-chart-container" style="width: 300px; height: 200px;"></div>
  </div>
  <br />
  <br />
  <div class="container-fluid">
    <div class="row">
      <div class="col-5 jumbotron p-2 mx-1">
        <h1 class="sensor1">TVOC :</h1>
      </div>
      <br />

      <div class="col-5 jumbotron p-2 mx-1">
        <h1 class="sensor2">ECO2 :</h1>
      </div>
      <br />
    </div>
  </div>

  <style>
    .jumbotron {
      widows: 150px;
      height: 220px;
      justify-content: center;
    }

    .row {
      justify-content: center;
    }

    .container-fluid {
      margin-top: 20px;
      height: 400px;
      /* Adjust the height according to your preference */
    }

    #data-TVOC,
    #data-ECO2 {
      height: 100%;
      /* Ensure the chart container takes 100% height of its parent */
    }
  </style>

  <div class="container-fluid">
    <!-- Example row of columns -->
    <div class="row">
      <div class="container-fluid" id="data-TVOC"></div>
    </div>
  </div>
  <br />
  <br />
  <br />

  <div class="container-fluid">
    <!-- Example row of columns -->
    <div class="row">
      <div class="container-fluid" id="data-ECO2"></div>
    </div>
  </div>

  <script>
    var chartTVOC;
    var chartECO2;
    var lastTimestamp = 0; // To keep track of the last fetched data point
    /*
          function requestData() {
            // Ajax call to get the Data from Flask
            $.get("/data", function (result) {
              result.forEach((dataPoint) => {
                var timestamp = result[0];
                // Only add data points that are newer than the last timestamp
                if (timestamp > lastTimestamp) {
                  chartTVOC.series[0].addPoint(
                    [timestamp, result[1]],
                    true,
                    false,
                  );
                  chartECO2.series[0].addPoint(
                    [timestamp, result[2]],
                    true,
                    false,
                  );
    
                  // Update the last timestamp
                  lastTimestamp = timestamp;
                }
              });
    
              // Update the displayed sensor values
              $(".sensor1").text(
                "TVOC : " + Math.round(result[result.length - 1][1]),
              );
              $(".sensor2").text(
                "eCO2 : " + Math.round(result[result.length - 1][2]),
              );
    
              // call requestData again after two seconds
              setTimeout(requestData, 5000);
            });
          }
    */
    // Sample data for gas concentrations and severity levels
    const gasData = {
      CH4: { value: 80, severity: 'High' },
      NO2: { value: 60, severity: 'Moderate' },
      NO: { value: 30, severity: 'Low' },
      CO: { value: 45, severity: 'Moderate' },
      TVOC: { value: 200, severity: 'High' },
      eCO2: { value: 300, severity: 'High' }
    };



    var TVOCDataPoints = [];
    var ECO2DataPoints = [];
    function gauge() {

      fetch('/data')
        .then(response => response.json())
        .then(result => {
          var CH4 = result[3];
          /////////
          Highcharts.chart('gauge-chart-container', {
            chart: {
              type: 'solidgauge'
            },
            title: {
              text: 'CH4 (Methane)'
            },
            pane: {
              center: ['50%', '85%'],
              size: '140%',
              startAngle: -90,
              endAngle: 90,
              background: {
                backgroundColor: Highcharts.defaultOptions.legend.backgroundColor || '#EEE',
                innerRadius: '60%',
                outerRadius: '100%',
                shape: 'arc'
              }
            },
            tooltip: {
              enabled: false
            },
            yAxis: {
              stops: [
                [0.1, '#55BF3B'], // Green (Low)
                [0.5, '#DDDF0D'], // Yellow (Moderate)
                [0.9, '#DF5353']  // Red (High)
              ],
              lineWidth: 0,
              tickWidth: 0,
              minorTickInterval: null,
              tickAmount: 2,
              title: {
                y: -70
              },
              labels: {
                y: 16
              },
              min: 0,
              max: 500
            },
            plotOptions: {
              solidgauge: {
                dataLabels: {
                  y: 5,
                  borderWidth: 0,
                  useHTML: true
                }
              }
            },
            series: [{
              name: 'Gas Concentration',
              data: [CH4.value],
              dataLabels: {
                format:
                  '<div style="text-align:center">' +
                  '<span style="font-size:20px">{y}</span><br/>' +
                  `<span style="font-size:12px;opacity:0.4">${CH4.severity}</span>` +
                  '</div>'
              },
              tooltip: {
                valueSuffix: ' ppm'
              }
            }]
          });

        });
}
    function fetchData() {
      fetch('/data')
        .then(response => response.json())
        .then(result => {
          var timestamp = result[0];
          var TVOC = result[1];
          var ECO2 = result[2];

          console.log(result)
          console.log('-----')
          console.log(gasData.CH4.value)

          ////////


          // Only add data points that are newer than the last timestamp
          if (timestamp > lastTimestamp) {
            TVOCDataPoints.push({ x: timestamp, y: TVOC });
            ECO2DataPoints.push({ x: timestamp, y: ECO2 });

            if (TVOCDataPoints.length > 20) {
              TVOCDataPoints.shift(); // Remove the first element (oldest data point)
            }

            if (ECO2DataPoints.length > 20) {
              ECO2DataPoints.shift(); // Remove the first element (oldest data point)
            }

            // Update the chart with the last 20 data points
            chartTVOC.xAxis[0].setExtremes(timestamp - 20000, timestamp);
            chartECO2.xAxis[0].setExtremes(timestamp - 20000, timestamp);

            // Update series data
            chartTVOC.series[0].setData(TVOCDataPoints);
            chartECO2.series[0].setData(ECO2DataPoints);

            // Update the last timestamp
            lastTimestamp = timestamp;
          }
          // Update the displayed sensor values
          $(".sensor1").text("TVOC : " + Math.round(TVOC));
          $(".sensor2").text("eCO2 : " + Math.round(ECO2));
        })
        .catch(error => {
          console.error('Error fetching data:', error);
        });
    }

    // Poll every second
    setInterval(fetchData, 1000);
    setInterval(gauge, 5000);



    $(document).ready(function () {
      // --------------Chart 1 ----------------------------
      chartTVOC = new Highcharts.Chart({
        chart: {
          renderTo: "data-TVOC",
          defaultSeriesType: "area",
          events: {
            load: fetchData,
          },
        },
        title: {
          text: "TVOC",
        },
        xAxis: {
          type: "datetime",
          tickPixelInterval: 150,
          maxZoom: 20 * 1000,
        },
        yAxis: {
          minPadding: 0.2,
          maxPadding: 0.2,
          title: {
            text: "Value",
            margin: 80,
          },
        },
        series: [
          {
            color: "#c23d23",
            lineColor: "#303030",
            name: "TVOC",
            data: [],
          },
        ],
      });
      // --------------Chart 1 Ends - -----------------

      chartECO2 = new Highcharts.Chart({
        chart: {
          renderTo: "data-ECO2",
          defaultSeriesType: "area",
          events: {
            load: fetchData,
          },
        },
        title: {
          text: "eCO2",
        },
        xAxis: {
          type: "datetime",
          tickPixelInterval: 150,
          maxZoom: 20 * 1000,
        },
        yAxis: {
          minPadding: 0.2,
          maxPadding: 0.2,
          title: {
            text: "Value",
            margin: 80,
          },
        },
        series: [
          {
            lineColor: "#1d82b8",
            name: "eCO2",
            data: [],
          },
        ],
      });
    });
    fetchData();
  </script>

  <script>
    class Image {
      constructor(imgUrl, size) {
        this.imgUrl = imgUrl;
        this.size = size;
      }

      backgroundImage() {
        console.log("inside function ");
        // Select the Image
        var img = document.querySelector(".jumbotron");

        // create Css Text
        var text =
          "margin:auto;" +
          "background-image: url(" +
          this.imgUrl +
          ");" +
          "background-size:cover;" +
          "opacity:1;" +
          "background-blend-mode: darken;" +
          "height: " +
          this.size +
          "vh;";

        img.style.cssText = text;
      }

      centerTitle() {
        /*
              Center the Title
           */
        var t1 = document.querySelector("#title");
        t1.classList.add("text-white");
        t1.classList.add("text-center");
        t1.classList.add("display-3");
      }
    }
    const imgUrl =
      "https://media3.giphy.com/media/26tn33aiTi1jkl6H6/giphy.gif";
    const size = "50";
    var obj = new Image(imgUrl, size);
    obj.backgroundImage();
    obj.centerTitle();
  </script>
</body>

</html>